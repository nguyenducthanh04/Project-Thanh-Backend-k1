<h4 style="text-align: center">Danh sách lớp học</h4>
<form action="/admin/deleteAllClass" method="POST" style="margin-bottom: 8px">
  <input type="hidden" id="listDelete" name="listUserDelete" value="" />
  <button type="submit" class="btn btn-danger" id="deleteAll">
    Xóa tất cả
  </button>
</form>
<form action="" class="mb-2">
  <div class="row">
    <div class="col-8 mb-2">
      <a href="/admin/importExcelClass" class="btn btn-info"
        >Import Excel <i class="fas fa-file-excel"></i
      ></a>
      <a href="/admin/exportClass" class="btn btn-success"
        >Export file excel <i class="fas fa-file-excel"></i
      ></a>
    </div>
    <div class="col-10">
      <input
        type="search"
        name="keyword"
        class="form-control"
        value="<%= req.query.keyword %>"
        placeholder="Tìm kiếm theo lớp học hoặc khóa học"
      />
    </div>
    <div class="col-2">
      <button type="submit" class="btn btn-primary">
        <i class="fas fa-search"></i>
      </button>
      <select name="typeId" class="form-select" style="margin-left: 4px">
        <option value="all">Tất cả</option>
        <option value="admin">Admin</option>
        <option value="teacher">Giảng viên</option>
        <option value="student">Học viên</option>
      </select>
    </div>
  </div>
</form>
<table class="table table-bordered">
  <thead>
    <tr>
      <th><input id="checkboxAll" type="checkbox" /></th>
      <th width="5%">STT</th>
      <th>Tên</th>
      <th>Sĩ số</th>
      <th>Ngày khai giảng</th>
      <th>Ngày kết thúc</th>
      <th>Lịch học</th>
      <th>Thời gian học</th>
      <th>Khóa học</th>
      <th>Thêm học viên</th>
      <th>Sửa</th>
      <th>Xóa</th>
    </tr>
  </thead>
  <tbody>
    <% classList.forEach((classItem, index) => { %>
    <tr>
      <td>
        <input
          class="checkboxItem"
          type="checkbox"
          value="<%= classItem.id %>"
        />
      </td>
      <td><%= index + 1 %></td>
      <td>
        <a href="/admin/classDetail/<%= classItem.id %>"
          ><%= classItem.name %></a
        >
      </td>
      <td><%= classItem.quantity %></td>
      <td><%= moment(classItem.startDate).format('MM/DD/YYYY') %></td>
      <td><%= moment(classItem.endDate).format('MM/DD/YYYY') %></td>
      <td>
        <% schedules.forEach((scheduleItem, index) => { %>
        <!-- <td> -->
        <% if(classItem.id === scheduleItem.classId) { %> <%=
        scheduleItem.schedule === 8 ? `Chủ nhật${index < schedules.length - 1 ?
        "," : ""}` : `Thứ ${scheduleItem.schedule}${index < schedules.length - 1
        ? "," : ""}`%> <% } %>
        <!-- </td> -->
        <% }) %>
      </td>
      <td>
        <% schedules.forEach((scheduleItem, index) => { %>
        <!-- <td> -->
        <% if(classItem.id === scheduleItem.classId) { %> <%=
        scheduleItem.timeLearn %><% } %>
        <!-- </td> -->

        <% }) %>
      </td>

      <!-- <td></td> -->
      <td><%= classItem.course.name %></td>
      <td>
        <a
          href="/admin/createStudentClass/<%= classItem.id %>"
          class="btn btn-success"
          >Thêm học viên</a
        >
      </td>
      <td>
        <a href="/admin/editClass/<%= classItem.id %>"
          ><i class="far fa-edit" style="font-size: 1.2rem"></i
        ></a>
      </td>
      <td>
        <form
          action="/admin/deleteClass/<%= classItem.id %>"
          onsubmit="return confirm('Bạn có chắc chắn muốn xóa lớp học ?')"
          method="post"
        >
          <button class="btn btn-sm">
            <i class="fas fa-trash-alt" style="font-size: 1.2rem"></i>
          </button>
        </form>
      </td>
    </tr>
    <% }) %>
  </tbody>
</table>

<script>
  const checkboxAll = document.querySelector("#checkboxAll");
  const inputDelete = document.querySelector("#listDelete");
  const checkboxCourses = document.querySelectorAll(".checkboxItem");
  const deleteAllBtn = document.querySelector("#deleteAll");
  let arr = [];

  checkboxAll.addEventListener("change", function (e) {
    const haveChecked = Array.from(checkboxCourses).some(
      (checkboxCourse) => checkboxCourse.checked
    );

    if (haveChecked) {
      e.target.checked = false;
      checkboxCourses.forEach((checkboxCourse) => {
        checkboxCourse.checked = false;
      });
      arr = [];
      inputDelete.value = "";
    }

    if (e.target.checked) {
      checkboxCourses.forEach((checkboxCourse) => {
        checkboxCourse.checked = true;
        arr.push(checkboxCourse.value);
      });
      inputDelete.value = arr.toString();
      return;
    }
    checkboxCourses.forEach((checkboxCourse) => {
      checkboxCourse.checked = false;
      arr = [];
    });
    inputDelete.value = "";
  });

  checkboxCourses.forEach((checkboxCourse) => {
    checkboxCourse.addEventListener("change", function (e) {
      if (!e.target.checked) {
        checkboxAll.checked = false;
        arr = arr.filter((val) => val !== e.target.value);
        inputDelete.value = arr.toString();
        return;
      }
      arr.push(e.target.value);
      inputDelete.value = arr.toString();
      checkboxAll.checked = Array.from(checkboxCourses).every(
        (checkboxCourse) => checkboxCourse.checked
      );
    });
  });

  deleteAllBtn.onclick = () => {
    arr = [...new Set(arr)];
    console.log(arr.toString());
  };
</script>
